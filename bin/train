#!/usr/bin/env python
from sys import argv, stdin
from orbax.checkpoint import StandardCheckpointer
from pyarrow.ipc import read_tensor
from pyarrow import input_stream
from ml.optimizer.create import create
from ml.paths.state import MODEL
from ml.state.save import save
from ml.train import train
from ml.load import load

with StandardCheckpointer() as checkpointer:
    steps = int(argv[1])
    stream = input_stream(stdin.buffer)
    model = load(checkpointer)
    optimizer = create(model)
    try:
        for step in range(1, steps + 1):
            x, y = read_tensor(stream), read_tensor(stream)
            x, y = x.to_numpy(), y.to_numpy()
            loss = train(optimizer, model, x, y)
            if step % 100 == 0:
                print(step, loss)
                save(checkpointer, MODEL, model)
    except KeyboardInterrupt:
        pass
