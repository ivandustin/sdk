#!/usr/bin/env python
from contextlib import suppress
from functools import partial
from sys import argv, stdin
from orbax.checkpoint import StandardCheckpointer
from pyarrow.ipc import read_tensor
from pyarrow import input_stream
from ml.optimizer.create import create
from ml.paths.state import MODEL
from ml.state.save import save
from ml.train import train
from ml.load import load


def main():
    with StandardCheckpointer() as checkpointer:
        steps = int(argv[1])
        epochs = int(argv[2])
        stream = input_stream(stdin.buffer)
        model = load(checkpointer)
        optimizer = create(model)
        learn = partial(train, optimizer, model)
        best = None
        for epoch in range(epochs):
            loss = 0
            for _ in range(steps):
                x = read_tensor(stream)
                y = read_tensor(stream)
                x = x.to_numpy()
                y = y.to_numpy()
                loss += learn(x, y)
            loss /= steps
            if best is None:
                best = loss
            if loss < best:
                best = loss
                save(checkpointer, MODEL, model)
            print(epoch, loss, best)


if __name__ == "__main__":
    with suppress(KeyboardInterrupt):
        main()
