#!/usr/bin/env python
from contextlib import suppress
from sys import argv, stdout
from random import choice
from pyarrow import Tensor, input_stream, output_stream
from pyarrow.ipc import read_tensor, write_tensor
from numpy.random import choice as npchoice
from numpy import stack


def main():
    size = int(argv[1])
    xpath = argv[2]
    ypath = argv[3]
    stream = output_stream(stdout.buffer)
    x = stack(list(readfile(xpath)))
    y = stack(list(readfile(ypath))).flatten()
    g = [x[y == i] for i in range(y.max() + 1)]
    with suppress(KeyboardInterrupt, BrokenPipeError):
        while True:
            y = npchoice(len(g), size=size)
            x = stack([choice(g[i]) for i in y])
            x = Tensor.from_numpy(x)
            y = Tensor.from_numpy(y)
            write_tensor(x, stream)
            write_tensor(y, stream)


def readfile(filepath):
    with input_stream(filepath) as stream:
        with suppress(Exception):
            while True:
                tensor = read_tensor(stream)
                yield tensor.to_numpy()


if __name__ == "__main__":
    main()
