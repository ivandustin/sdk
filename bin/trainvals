#!/usr/bin/env bash
set -euvxo pipefail
idx $(<range.txt) < values.txt > index.txt
ctx $(<context.txt) index.txt < values.txt > x.txt
val index.txt < values.txt > y.txt
sym < x.txt > xs.txt
sym < y.txt > ys.txt
wc -l < xs.txt > symbols.txt
wc -l < ys.txt > classes.txt
(
	cat context.txt
	yes $(<symbols.txt) | head -n $(<vars.txt)
) | xargs > embeds.txt
sym2idx xs.txt < x.txt > xi.txt
sym2idx ys.txt < y.txt > yi.txt
encode $(<vars.txt) < xi.txt > x.ipc
tensor int < yi.txt > y.ipc
batchxy $(<batch.txt) x.ipc y.ipc | train $(<steps.txt) $(<epochs.txt)
