#!/usr/bin/env python
from functools import partial
from asyncio import Queue, run
from sys import argv, stdin
from websockets import serve


async def main():
    port = int(argv[1])
    mq = Queue()
    fn = partial(rcv, mq)
    async with serve(fn, "localhost", port):
        while True:
            q, msg = await mq.get()
            print(msg)
            out = next(stdin)
            await q.put(out)


async def rcv(mq, ws):
    q = Queue()
    async for msg in ws:
        await mq.put((q, msg))
        out = await q.get()
        await ws.send(out)


run(main())
