#!/usr/bin/env python
from sys import stdin, stdout
from orbax.checkpoint import StandardCheckpointer
from pyarrow import Tensor, output_stream
from pyarrow.ipc import write_tensor
from flax.nnx import softmax
from numpy import asarray
from ml.load import load
from npstr import decode

ostream = output_stream(stdout.buffer)
with StandardCheckpointer() as checkpointer:
    model = load(checkpointer)
for line in stdin:
    x = decode(line)
    y = softmax(model(x))
    y = Tensor.from_numpy(asarray(y))
    write_tensor(y, ostream)
