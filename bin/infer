#!/usr/bin/env python
from contextlib import suppress
from sys import stdin, stdout
from pyarrow import Tensor, input_stream, output_stream
from pyarrow.ipc import read_tensor, write_tensor
from orbax.checkpoint import StandardCheckpointer
from flax.nnx import softmax
from numpy import asarray
from ml.load import load

istream = input_stream(stdin.buffer)
ostream = output_stream(stdout.buffer)
with StandardCheckpointer() as checkpointer:
    model = load(checkpointer)
with suppress(Exception):
    while True:
        x = read_tensor(istream).to_numpy()
        y = softmax(model(x))
        y = Tensor.from_numpy(asarray(y))
        write_tensor(y, ostream)
